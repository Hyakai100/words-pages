  <!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>単語帳アプリ（共有版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      text-align: center;
      background: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 16px;
      margin-top: 24px;
      margin-bottom: 8px;
    }
    #card {
      margin: 12px auto 8px;
      padding: 24px;
      max-width: 340px;
      border-radius: 16px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      background: #ffffff;
      cursor: pointer;
      user-select: none;
    }
    #front {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    #back {
      font-size: 18px;
      color: #555;
      display: none;
    }
    #status {
      margin-bottom: 4px;
      color: #666;
      font-size: 14px;
    }
    #hint {
      margin-bottom: 8px;
      color: #888;
      font-size: 12px;
    }
    button {
      margin: 4px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #eeeeee;
    }
    button:active {
      transform: scale(0.97);
    }
    #btn-prev, #btn-next {
      min-width: 70px;
    }
    #btn-toggle {
      min-width: 140px;
    }
    #btn-delete {
      margin-top: 4px;
      background: #ffdddd;
    }
    #btn-reset {
      margin-top: 4px;
      background: #e0f0ff;
      font-size: 12px;
    }

    #add-form {
      margin: 0 auto;
      max-width: 360px;
      text-align: left;
      background: #ffffff;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    #add-form label {
      font-size: 13px;
      display: block;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    #add-form input {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      margin-bottom: 4px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #add-form button {
      width: 100%;
      margin-top: 6px;
      background: #d7ffd7;
    }

    #message {
      margin-top: 8px;
      font-size: 12px;
      color: #888;
    }

    #loading {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>

  <h1>単語帳アプリ（共有版）</h1>
  <div id="status"></div>
  <div id="hint">カードをタップすると、答えの表示 / 非表示が切り替わります。</div>

  <div id="card">
    <div id="front"></div>
    <div id="back"></div>
  </div>

  <div>
    <button id="btn-prev">前へ</button>
    <button id="btn-toggle">答えを表示 / 非表示</button>
    <button id="btn-next">次へ</button>
  </div>

  <div>
    <button id="btn-delete">この単語を削除</button>
  </div>

  <div>
    <button id="btn-reset">初期の単語に戻す</button>
  </div>

  <div style="margin-top:20px;">
    <button id="btn-manage" style="
      padding:10px 20px;
      border-radius: 999px;
      border:none;
      cursor:pointer;
      background:#d0eaff;
      font-size:14px;
    ">
      管理画面を開く
    </button>
  </div>

  
  <h2>管理者ログイン</h2>
  <div id="login-box">
    <input id="login-email" type="email" placeholder="メールアドレス">
    <input id="login-password" type="password" placeholder="パスワード">
    <button id="btn-login">ログイン</button>
    <button id="btn-logout" style="display:none;">ログアウト</button>
    <div id="login-message"></div>
  </div>
  
  <h2>単語を追加する（全員に共有されます）</h2>
  <div id="add-form">
    <label for="input-front">表（例: apple）</label>
    <input id="input-front" type="text" placeholder="英単語など">

    <label for="input-back">裏（例: りんご）</label>
    <input id="input-back" type="text" placeholder="意味など">

    <button id="btn-add">この単語を追加</button>
  </div>

  <div id="loading">読み込み中...</div>
  <div id="message"></div>

  <!-- Firebase (compat 版) のCDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyCOuuKZgLFJn4Mh4jhcrZW2TWnutCeculU",
      authDomain: "workbook-shared.firebaseapp.com",
      projectId: "workbook-shared",
      storageBucket: "workbook-shared.firebasestorage.app",
      messagingSenderId: "1085640006832",
      appId: "1:1085640006832:web:f4281d6bbc1830f8e66f75",
      measurementId: "G-MCPQTQJ584"
    };

    // ▼ Firebase 初期化
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ▼ Firestore 上で使う場所
    const docRef = db.collection("wordbooks").doc("default");

    // ▼ 初期データ
    const defaultCards = [
      { front: "apple",  back: "りんご" },
      { front: "banana", back: "バナナ" },
      { front: "grape",  back: "ぶどう" },
      { front: "orange", back: "オレンジ" },
      { front: "peach",  back: "もも" }
    ];

    let cards = [];
    let currentIndex = 0;
    let isBackVisible = false;

    const frontEl   = document.getElementById("front");
    const backEl    = document.getElementById("back");
    const statusEl  = document.getElementById("status");
    const cardEl    = document.getElementById("card");
    const btnPrev   = document.getElementById("btn-prev");
    const btnNext   = document.getElementById("btn-next");
    const btnToggle = document.getElementById("btn-toggle");
    const btnDelete = document.getElementById("btn-delete");
    const btnReset  = document.getElementById("btn-reset");
    const inputFront = document.getElementById("input-front");
    const inputBack  = document.getElementById("input-back");
    const btnAdd     = document.getElementById("btn-add");
    const messageEl  = document.getElementById("message");
    const loadingEl  = document.getElementById("loading");
    const loginEmail = document.getElementById("login-email");
    const loginPassword = document.getElementById("login-password");
    const btnLogin = document.getElementById("btn-login");
    const btnLogout = document.getElementById("btn-logout");
    const loginMessage = document.getElementById("login-message");

    // 配列をランダムにシャッフルする関数（Fisher–Yates）
    function shuffle(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function setUiEnabled(enabled) {
      // 読み込み中に “移動系” だけ止める
      btnPrev.disabled = !enabled;
      btnNext.disabled = !enabled;
      btnToggle.disabled = !enabled;
      // 編集ボタン・入力欄はここでは触らない
    }

    function enableEditButtons(enabled) {
      btnAdd.disabled = !enabled;
      btnDelete.disabled = !enabled;
      btnReset.disabled = !enabled;

      // 見た目も少しグレーにする
      btnAdd.style.opacity = enabled ? 1 : 0.4;
      btnDelete.style.opacity = enabled ? 1 : 0.4;
      btnReset.style.opacity = enabled ? 1 : 0.4;
    }    

    function showMessage(text) {
      messageEl.textContent = text || "";
      if (!text) return;
      setTimeout(() => {
        if (messageEl.textContent === text) {
          messageEl.textContent = "";
        }
      }, 2500);
    }

    function renderCard() {
      if (cards.length === 0) {
        frontEl.textContent = "単語がありません";
        backEl.textContent = "追加してください";
        backEl.style.display = "block";
        statusEl.textContent = "0 / 0";
        return;
      }
      const card = cards[currentIndex];
      frontEl.textContent = card.front;
      backEl.textContent  = card.back;
      statusEl.textContent = `${currentIndex + 1} / ${cards.length}`;
      backEl.style.display = isBackVisible ? "block" : "none";
      btnDelete.disabled = (cards.length <= 1);
    }

    function move(delta) {
      if (cards.length === 0) return;
      currentIndex += delta;
      if (currentIndex < 0) currentIndex = cards.length - 1;
      if (currentIndex >= cards.length) currentIndex = 0;
      isBackVisible = false;
      renderCard();
    }

    async function saveCardsToServer() {
      await docRef.set({ cards }, { merge: false });
    }

    async function loadCardsFromServer() {
      loadingEl.textContent = "読み込み中...";
      setUiEnabled(false);
      try {
        const snap = await docRef.get();
        if (snap.exists) {
          const data = snap.data();
          if (Array.isArray(data.cards) && data.cards.length > 0) {
            cards = data.cards;
          } else {
            cards = [...defaultCards];
            await saveCardsToServer();
          }
        } else {
          cards = [...defaultCards];
          await saveCardsToServer();
        }
      } catch (e) {
        console.error(e);
        cards = [...defaultCards];
        showMessage("読み込みに失敗したので初期データを表示します。");
      } finally {

        cards = shuffle(cards);

        currentIndex = 0;
        isBackVisible = false;
        renderCard();
        loadingEl.textContent = "";
        setUiEnabled(true);
      }
    }

    btnPrev.addEventListener("click", () => move(-1));
    btnNext.addEventListener("click", () => move(1));

    // ログイン処理
    btnLogin.addEventListener("click", () => {
      auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value)
        .then(() => {
          loginMessage.textContent = "ログイン成功！";
        })
        .catch(err => {
          loginMessage.textContent = "ログイン失敗: " + err.message;
        });
    });
    
    // ログアウト処理
    btnLogout.addEventListener("click", () => {
      auth.signOut();
    });
    
    // ログイン状態が変わったときに呼ばれる
    auth.onAuthStateChanged(user => {
      if (user) {
        // ログイン時
        btnLogin.style.display = "none";
        btnLogout.style.display = "inline-block";
        loginMessage.textContent = "ログイン中";
    
        enableEditButtons(true); // 編集ボタンを有効化
      } else {
        // ログアウト時
        btnLogin.style.display = "inline-block";
        btnLogout.style.display = "none";
        loginMessage.textContent = "ログアウト中";
    
        enableEditButtons(false); // 編集ボタンを無効化
      }
    });

    
    btnToggle.addEventListener("click", () => {
      if (cards.length === 0) return;
      isBackVisible = !isBackVisible;
      renderCard();
    });
    cardEl.addEventListener("click", () => {
      if (cards.length === 0) return;
      isBackVisible = !isBackVisible;
      renderCard();
    });

    btnAdd.addEventListener("click", async () => {

      if (!auth.currentUser) {
        showMessage("編集するにはログインしてください。");
        return;
      }
      const front = inputFront.value.trim();
      const back  = inputBack.value.trim();
      if (!front || !back) {
        showMessage("表と裏の両方を入力してください。");
        return;
      }
      setUiEnabled(false);
      try {
        cards.push({ front, back });
        await saveCardsToServer();
        currentIndex = cards.length - 1;
        isBackVisible = false;
        renderCard();
        inputFront.value = "";
        inputBack.value  = "";
        inputFront.focus();
        showMessage("単語を追加しました。（全体に反映されます）");
      } catch (e) {
        console.error(e);
        showMessage("追加に失敗しました。");
      } finally {
        setUiEnabled(true);
      }
    });

    inputBack.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnAdd.click();
    });

    btnDelete.addEventListener("click", async () => {
      if (!auth.currentUser) {
        showMessage("編集するにはログインしてください。");
        return;
      }

      
      if (cards.length <= 1) {
        alert("最後の1件は削除できません。");
        return;
      }
      const card = cards[currentIndex];
      const ok = confirm(`この単語を削除しますか？\n\n${card.front} - ${card.back}`);
      if (!ok) return;
      setUiEnabled(false);
      try {
        cards.splice(currentIndex, 1);
        if (currentIndex >= cards.length) {
          currentIndex = cards.length - 1;
        }
        isBackVisible = false;
        await saveCardsToServer();
        renderCard();
        showMessage("単語を削除しました。（全体に反映されます）");
      } catch (e) {
        console.error(e);
        showMessage("削除に失敗しました。");
      } finally {
        setUiEnabled(true);
      }
    });

    btnReset.addEventListener("click", async () => {
      const ok = confirm("単語リストを初期状態に戻しますか？\n（全員に反映されます）");
      if (!ok) return;
      setUiEnabled(false);
      try {
        cards = [...defaultCards];
        currentIndex = 0;
        isBackVisible = false;
        await saveCardsToServer();
        renderCard();
        showMessage("初期の単語に戻しました。（全体に反映されます）");
      } catch (e) {
        console.error(e);
        showMessage("リセットに失敗しました。");
      } finally {
        setUiEnabled(true);
      }
    });

    // 初回読み込み
    loadCardsFromServer();
    enableEditButtons(false);

    document.getElementById("btn-manage").addEventListener("click", () => {
      window.location.href = "https://hyakai100.github.io/words-pages/manage.html";
    });
  </script>
</body>
</html>



